# Feature Plan: Uploads, Processing & Storage

## Objective
Create a reliable upload and processing pipeline for originals and derivatives.

## Scope
- Secure upload session creation
- Cloud Storage object conventions
- Derivative generation (thumbnail/web previews)
- EXIF extraction and metadata persistence
- Quota accounting and lifecycle management

## Current implemented contract baseline (Phase 2a)

- Canonical object key format: `uploads/YYYY/MM/DD/<slugified-file-name>`
  - validated by `isValidCanonicalObjectKey`
  - generated by `buildCanonicalObjectKey`
- Upload session creation:
  - accepts `fileName`
  - optionally accepts `clientRequestId` for retry-safe create calls
  - duplicate `clientRequestId` + same file name returns the original session
  - duplicate `clientRequestId` + different file name is rejected
- Upload finalize:
  - requires `sessionId` + `idempotencyKey`
  - duplicate finalize calls replay prior result without creating duplicate metadata/jobs
- Metadata baseline:
  - immutable `sourcePointer` (for current adapter: `gs://aurapix-dev/<objectKey>`)
  - `processingState` lifecycle: `pending_processing` â†’ `completed`
- Derivative job envelope baseline:
  - includes `jobId`, `idempotencyKey`, `metadataUploadId`, `objectKey`, and `status`

## Planned detail expansion
- Upload workflow sequence diagram
- Cloud Functions/Cloud Run processing responsibilities
- Retry/idempotency strategy
- Storage usage counters and reconciliation jobs
- Soft delete/trash retention and hard delete policies
